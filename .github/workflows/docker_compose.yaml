# ğŸš€ Simple Docker CI/CD Pipeline
# This pipeline automatically builds and deploys your app when you push code

name: Deploy App to EC2

# ğŸ”„ When to run: Every time you push to this branch
on:
  push:
    branches:
      - docker_compose_access_the_app  # Change this to your main branch name

jobs:
  deploy:
    runs-on: ubuntu-latest  # Use GitHub's Ubuntu server
    
    steps:
      # ğŸ“¥ Step 1: Download your code from GitHub
      - name: ğŸ“¥ Get Code from GitHub
        uses: actions/checkout@v4

      # âš™ï¸ Step 2: Install Node.js (needed to check JavaScript)
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # Use Node.js version 18

      # âœ… Step 3: Check if your JavaScript code has errors
      - name: âœ… Test Frontend Code
        run: |
          echo "ğŸ” Checking frontend JavaScript files..."
          find ./client -name "*.js" -exec node --check {} + || echo "No JS files found in ./client"
        
      - name: âœ… Test Backend Code  
        run: |
          echo "ğŸ” Checking backend JavaScript files..."
          find ./api -name "*.js" -exec node --check {} + || echo "No JS files found in ./api"

      # ğŸ” Step 4: Login to DockerHub (where we store Docker images)
      - name: ğŸ” Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # Your DockerHub username
          password: ${{ secrets.DOCKER_PASSWORD }}  # Your DockerHub password/token

      # ğŸ—ï¸ Step 5: Build Backend Docker Image and Upload
      - name: ğŸ—ï¸ Build & Upload Backend Image
        run: |
          echo "ğŸ³ Building backend Docker image..."
          docker build -t ${{ secrets.DOCKER_USERNAME }}/backend:latest ./api
          echo "ğŸ“¤ Uploading backend image to DockerHub..."
          docker push ${{ secrets.DOCKER_USERNAME }}/backend:latest
          echo "âœ… Backend image uploaded successfully!"

      # ğŸ—ï¸ Step 6: Build Frontend Docker Image and Upload  
      - name: ğŸ—ï¸ Build & Upload Frontend Image
        run: |
          echo "ğŸ³ Building frontend Docker image..."
          docker build -t ${{ secrets.DOCKER_USERNAME }}/frontend:latest ./client
          echo "ğŸ“¤ Uploading frontend image to DockerHub..."
          docker push ${{ secrets.DOCKER_USERNAME }}/frontend:latest
          echo "âœ… Frontend image uploaded successfully!"

      # ğŸš€ Step 7: Deploy to your EC2 server
      - name: ğŸš€ Deploy to EC2 Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}      # Your EC2 IP address
          username: ${{ secrets.EC2_USER }}  # Usually "ubuntu" or "ec2-user"
          key: ${{ secrets.EC2_SSH_KEY }}    # Your EC2 private key
          timeout: 300s                      # Wait max 5 minutes
          script: |
            echo "ğŸ¯ Starting deployment on EC2..."
            
            # ğŸ“ Create app directory if it doesn't exist
            APP_DIR="/home/$USER/app"
            mkdir -p $APP_DIR
            cd $APP_DIR
            echo "ğŸ“‚ Working in: $APP_DIR"
            
            # ğŸ“¥ Get your latest code
            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Cloning repository for first time..."
              git clone https://github.com/${{ github.repository }} .
            else
              echo "ğŸ“¥ Pulling latest code..."
              git pull origin docker_compose_access_the_app
            fi
            
            # ğŸ³ Download the new Docker images you just built
            echo "ğŸ³ Downloading latest Docker images..."
            docker compose pull
            
            # ğŸ›‘ Stop old containers (if running)
            echo "ğŸ›‘ Stopping old containers..."
            docker compose down
            
            # ğŸš€ Start new containers with updated code
            echo "ğŸš€ Starting new containers..."
            docker compose up -d
            
            # âœ… Show running containers
            echo "âœ… Deployment complete! Running containers:"
            docker compose ps
            
            echo "ğŸ‰ Your app is now live at: http://${{ secrets.EC2_HOST }}"
